<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Check-In Tamu (Scanner)</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<style>
:root{
  --bg:#2c3e50; --accent:#2ea0ff; --ok:#2ecc71; --err:#ff6b6b; --muted:#9fb3c0;
}
body{
  margin:0; font-family:Poppins,sans-serif; background:#233041; color:#ecf0f1;
  display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;
}
.card{
  background:#2c3e50; padding:26px 32px; border-radius:16px;
  box-shadow:0 15px 35px rgba(0,0,0,0.3);
  max-width:860px; width:95%; text-align:center; position:relative;
}
h1{color:var(--accent);margin:0 0 16px;font-size:26px;}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:14px;}
select,button{padding:10px 14px;border-radius:8px;border:none;font-weight:600;cursor:pointer;}
select{background:#fff;color:#333;}
button{background:var(--accent);color:#042b33;}
.preview-wrap{
  position:relative; display:flex; align-items:center; justify-content:center;
  width:100%; max-width:640px; margin:auto; border-radius:12px; overflow:hidden;
  background:#111; aspect-ratio:16/10;
}
#reader{width:100%;height:100%;opacity:0;transition:opacity .45s ease;}
#reader.active{opacity:1;}
#status{margin-top:18px;font-weight:600;min-height:22px;}
.success{color:var(--ok);} .error{color:var(--err);}

/* placeholder */
.placeholder{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:14px; padding:20px; color:var(--muted);
  background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(0,0,0,0.18));
  backdrop-filter:blur(4px);
  transition:opacity .35s ease, transform .35s ease;
}
.placeholder.hidden{opacity:0;transform:translateY(8px);pointer-events:none;}
.placeholder .box{
  width:88%; max-width:560px; aspect-ratio:16/10;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));
  border-radius:12px; display:flex;align-items:center;justify-content:center;
  color:#9fb3bd; font-style:italic; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.05);
}
.spinner{
  width:44px;height:44px;border-radius:50%;border:5px solid rgba(255,255,255,0.06);
  border-top-color:var(--accent);animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.skeleton{
  width:48%; max-width:420px; height:10px; border-radius:6px;
  background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.06),rgba(255,255,255,0.03));
  animation:shimmer 1.6s linear infinite;
}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}

/* overlay success */
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  z-index:100;opacity:0;pointer-events:none;transition:opacity .3s;
}
#overlay.active{opacity:1;pointer-events:auto;}
.circle{
  width:110px;height:110px;border-radius:50%;border:6px solid var(--ok);
  display:flex;align-items:center;justify-content:center;font-size:46px;color:var(--ok);
  animation:pop .4s ease;
}
@keyframes pop{0%{transform:scale(0.6);opacity:.2;}100%{transform:scale(1);opacity:1;}}
</style>
</head>
<body>

<div id="overlay">
  <div class="circle"><i class="fas fa-check"></i></div>
  <h2 style="margin-top:18px">Tamu sudah dicheck-in</h2>
</div>

<div class="card">
  <h1><i class="fas fa-qrcode"></i> Check-In Tamu (Scanner)</h1>

  <div class="controls">
    <button id="requestCamera">Izinkan Kamera / Pilih Kamera</button>
    <select id="cameraSelect"></select>
    <button id="useCamera">Gunakan</button>
    <button id="startBtn">Start Camera</button>
    <button id="stopBtn">Stop</button>
  </div>

  <div class="preview-wrap">
    <div class="placeholder" id="placeholder">
      <div class="box">
        <div style="text-align:center;">
          <div style="font-weight:700;color:#c8dfe6;margin-bottom:8px;">Memulai kamera...</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.7)">Jika pakai Iriun: buka app Iriun di HP & driver di PC lalu pilih “Iriun Webcam”.</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:14px;flex-direction:column;">
        <div class="spinner"></div>
        <div class="skeleton"></div>
      </div>
    </div>

    <div id="reader"></div>
  </div>

  <div id="status">Menunggu kamera...</div>
</div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzQGI4FovddaKryGQcEWiNEEss3dyd5egMI7VCoAFMhOwAPY6X95ybzQyaOI5n1GYuJ1A/exec';
const CHECKIN_KEY = 'Xk3!9sT-2025';
const INVITE_DOMAIN = 'anau23.github.io';

const readerEl = document.getElementById('reader');
const placeholderEl = document.getElementById('placeholder');
const statusEl = document.getElementById('status');
const overlay = document.getElementById('overlay');
const cameraSelect = document.getElementById('cameraSelect');
const requestCameraBtn = document.getElementById('requestCamera');
const useCameraBtn = document.getElementById('useCamera');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

let html5QrCode=null, selectedDeviceId=null, busy=false;

function setStatus(text,type=''){statusEl.textContent=text;statusEl.className=type;}
function showOverlay(msg='Tamu sudah dicheck-in'){
  overlay.querySelector('h2').textContent=msg;
  overlay.classList.add('active');
  playSuccessSound();
  setTimeout(()=>overlay.classList.remove('active'),1800);
}
function playSuccessSound(){new Audio('https://assets.mixkit.co/active_storage/sfx/2568/sfx-confirmation.wav').play();}
function playErrorSound(){new Audio('https://assets.mixkit.co/active_storage/sfx/2569/sfx-alert.wav').play();}

requestCameraBtn.onclick=async()=>{
  try{await navigator.mediaDevices.getUserMedia({video:true});}catch(e){setStatus('Izin kamera ditolak','error');return;}
  const devices=await Html5Qrcode.getCameras();
  cameraSelect.innerHTML='';
  devices.forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d.id;opt.text=d.label||d.id;
    cameraSelect.appendChild(opt);
  });
  const idx=[...cameraSelect.options].findIndex(o=>o.text.toLowerCase().includes('iriun'));
  if(idx>=0)cameraSelect.selectedIndex=idx;
  setStatus('Kamera ditemukan. Pilih lalu klik Gunakan.','success');
};

useCameraBtn.onclick=()=>{
  selectedDeviceId=cameraSelect.value;
  if(!selectedDeviceId)return setStatus('Pilih kamera dulu.','error');
  if(!html5QrCode)html5QrCode=new Html5Qrcode('reader');
  setStatus('Klik Start Camera untuk memulai.','success');
};

startBtn.onclick=async()=>{
  if(!selectedDeviceId)return setStatus('Pilih kamera dulu.','error');
  if(!html5QrCode)html5QrCode=new Html5Qrcode('reader');
  placeholderEl.classList.remove('hidden');
  readerEl.classList.remove('active');
  try{
    await html5QrCode.start({deviceId:{exact:selectedDeviceId}},{fps:10,qrbox:{width:250,height:250}},onScanSuccess,onScanFailure);
    placeholderEl.classList.add('hidden');
    readerEl.classList.add('active');
    setStatus('Memindai... Arahkan QR ke kamera.','success');
  }catch(e){
    placeholderEl.classList.remove('hidden');
    readerEl.classList.remove('active');
    setStatus('Gagal memulai kamera.','error');
  }
};

stopBtn.onclick=async()=>{
  if(html5QrCode){try{await html5QrCode.stop();html5QrCode.clear();}catch(e){}}
  placeholderEl.classList.remove('hidden');
  readerEl.classList.remove('active');
  setStatus('Kamera dihentikan.');
};

function onScanSuccess(decodedText){
  if(busy)return;
  busy=true;
  let guestId;
  try{const u=new URL(decodedText);guestId=u.searchParams.get('guest')||decodedText;}catch{guestId=decodedText;}
  setStatus('QR terbaca. Mengirim ke server...');
  doCheckinJSONP(guestId).then(()=>setTimeout(()=>busy=false,1500));
}
function onScanFailure(){}

function doCheckinJSONP(id){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*999);
    window[cb]=function(data){
      document.getElementById(cb+'_script')?.remove();
      delete window[cb];
      if(data.success){
        showOverlay('Selamat datang, '+data.name+'!');
        setStatus('Tamu '+data.name+' berhasil dicheck-in.','success');
      }else{
        setStatus(data.error||'Gagal check-in','error');
        playErrorSound();
      }
      resolve();
    };
    const src=`${BACKEND_URL}?action=checkin&id=${encodeURIComponent(id)}&callback=${cb}&key=${encodeURIComponent(CHECKIN_KEY)}&source=${encodeURIComponent(INVITE_DOMAIN)}`;
    const s=document.createElement('script');s.id=cb+'_script';s.src=src;
    s.onerror=()=>{setStatus('Gagal konek ke server.','error');playErrorSound();reject();};
    document.body.appendChild(s);
  });
}
</script>
</body>
</html>

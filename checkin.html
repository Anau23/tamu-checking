<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-In Tamu (Scanner)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #34495e;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: #2c3e50;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      color: #ecf0f1;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      max-width: 650px;
      width: 90%;
    }
    h1 {
      color: #3498db;
      margin-bottom: 20px;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 15px auto;
      border: 2px solid #3498db;
      border-radius: 10px;
    }
    #result {
      margin-top: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      min-height: 60px;
    }
    .success { color: #2ecc71; }
    .error { color: #e74c3c; }
    .info { color: #f1c40f; }
    select, button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    button {
      background: #3498db;
      color: #fff;
      font-weight: 600;
    }
    button:hover { background: #2980b9; }
  </style>
</head>
<body>

  <div class="container">
    <h1><i class="fas fa-qrcode"></i> Check-In Tamu (Scanner)</h1>

    <div>
      <button id="requestCamera">Izinkan Kamera / Pilih Kamera</button>
      <select id="cameraSelect"></select>
      <button id="useCamera">Gunakan</button>
      <button id="startBtn">Start Camera</button>
      <button id="stopBtn">Stop</button>
    </div>

    <div id="reader"></div>
    <div id="result" class="info">Camera preview akan muncul di sini.</div>
  </div>

  <script>
    // Konfigurasi utama
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzQGI4FovddaKryGQcEWiNEEss3dyd5egMI7VCoAFMhOwAPY6X95ybzQyaOI5n1GYuJ1A/exec';
    const CHECKIN_KEY = 'Xk3!9sT-2025';
    const INVITE_DOMAIN = 'anau23.github.io';

    const resultDiv = document.getElementById('result');
    const cameraSelect = document.getElementById('cameraSelect');
    const requestCameraBtn = document.getElementById('requestCamera');
    const useCameraBtn = document.getElementById('useCamera');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    let html5QrCode;
    let selectedCameraId = null;

    // ==== Fungsi inisialisasi kamera ====
    async function initCameraList() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        if (devices && devices.length) {
          devices.forEach(cam => {
            const option = document.createElement('option');
            option.value = cam.id;
            option.text = cam.label || `Camera ${cam.id}`;
            cameraSelect.appendChild(option);
          });
          resultDiv.textContent = "Pilih kamera, lalu klik 'Gunakan'.";
        } else {
          resultDiv.innerHTML = "<p class='error'>Tidak ada kamera terdeteksi.</p>";
        }
      } catch (err) {
        console.error("Error getting camera list:", err);
        resultDiv.innerHTML = "<p class='error'>Gagal mendapatkan daftar kamera.</p>";
      }
    }

    requestCameraBtn.onclick = async () => {
      await initCameraList();
    };

    useCameraBtn.onclick = async () => {
      selectedCameraId = cameraSelect.value;
      if (!selectedCameraId) {
        resultDiv.innerHTML = "<p class='error'>Pilih kamera terlebih dahulu.</p>";
        return;
      }
      html5QrCode = new Html5Qrcode("reader");
      resultDiv.innerHTML = "<p class='info'>Kamera siap digunakan. Klik 'Start Camera'.</p>";
    };

    startBtn.onclick = () => {
      if (!selectedCameraId) {
        resultDiv.innerHTML = "<p class='error'>Pilih kamera dulu.</p>";
        return;
      }

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };
      html5QrCode.start(
        { deviceId: { exact: selectedCameraId } },
        config,
        onScanSuccess,
        onScanFailure
      ).then(() => {
        resultDiv.innerHTML = "<p class='info'>Memulai kamera...</p>";
      }).catch(err => {
        console.error("Start camera error:", err);
        resultDiv.innerHTML = "<p class='error'>Gagal memulai kamera terpilih. Coba pilih yang lain atau reload.</p>";
      });
    };

    stopBtn.onclick = () => {
      if (html5QrCode) html5QrCode.stop().then(() => {
        resultDiv.innerHTML = "<p class='info'>Kamera dihentikan.</p>";
      }).catch(err => console.error(err));
    };

    // ==== QR SCAN HANDLER ====
    function onScanSuccess(decodedText) {
      console.log("QR Detected:", decodedText);
      let guestId;
      try {
        const url = new URL(decodedText);
        guestId = url.searchParams.get("guest");
      } catch {
        guestId = decodedText;
      }

      if (!guestId) {
        resultDiv.innerHTML = `<p class='error'>QR Code tidak valid.</p>`;
        playErrorSound();
        return;
      }
      checkInGuest(guestId);
    }

    function onScanFailure(error) {
      // kita biarkan kosong agar tidak spam error
    }

    async function checkInGuest(id) {
      resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i>';
      try {
        const cbName = "cb_" + Date.now();
        const script = document.createElement('script');
        window[cbName] = function(data) {
          if (data.success) {
            resultDiv.innerHTML = `<p class='success'>✅ Selamat datang, ${data.name}!</p>`;
            playSuccessSound();
          } else {
            resultDiv.innerHTML = `<p class='error'>⚠️ ${data.error}</p>`;
            playErrorSound();
          }
          delete window[cbName];
          script.remove();
        };
        script.src = `${BACKEND_URL}?action=checkin&id=${encodeURIComponent(id)}&callback=${cbName}&key=${CHECKIN_KEY}&source=${INVITE_DOMAIN}`;
        document.body.appendChild(script);
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class='error'>Gagal terhubung ke server.</p>`;
        playErrorSound();
      }
    }

    function playSuccessSound() {
      new Audio('https://assets.mixkit.co/active_storage/sfx/2568/sfx-confirmation.wav').play();
    }
    function playErrorSound() {
      new Audio('https://assets.mixkit.co/active_storage/sfx/2569/sfx-alert.wav').play();
    }
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistem Check-In Tamu (Scanner Otomatis)</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: #34495e; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0; }
        .container { background:#2c3e50;padding:30px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.2);text-align:center;max-width:640px;width:94%;color:#ecf0f1 }
        h1{color:#3498db;margin:0 0 8px}
        p.small{color:#bdc3c7;margin-top:0;margin-bottom:14px}
        #reader{width:100%;max-width:520px;margin:18px auto;border-radius:10px;overflow:hidden;border:2px solid #2ea0ff;height:360px;background:#000}
        #result{margin-top:18px;font-size:1.05rem;font-weight:600;min-height:56px}
        .success{color:#2ecc71}.error{color:#ff6b6b}.info{color:#f39c12}
        .scanning-text{color:#bdc3c7;font-style:italic}
        .spinner{display:inline-block;width:34px;height:34px;border-radius:50%;border:4px solid rgba(255,255,255,0.08);border-top-color:#2ea0ff;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-qrcode"></i> Check-In Tamu Syukuran</h1>
        <p class="small">Arahkan QR Code ke kamera untuk check-in otomatis. (Jika QR berisi link, sistem akan ambil parameter <code>guest</code>.)</p>

        <div id="reader"></div>

        <div id="result"><p class="scanning-text">Menunggu QR Code...</p></div>
    </div>

<script>
/* ================= CONFIG - ganti kalau perlu ================= */
// URL Web App Apps Script (deploy web app "Anyone, even anonymous")
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzQGI4FovddaKryGQcEWiNEEss3dyd5egMI7VCoAFMhOwAPY6X95ybzQyaOI5n1GYuJ1A/exec';
// Token rahasia (harus sama dengan Script Properties di Apps Script)
const CHECKIN_KEY = 'Xk3!9sT-2025';
// Domain GitHub Pages host (hostname saja)
const INVITE_DOMAIN = 'anau23.github.io';
/* ============================================================ */

const resultDiv = document.getElementById('result');

// jika decodedText adalah URL penuh, ambil param guest; kalau bukan, pakai langsung
function extractGuestId(decodedText) {
    try {
        const u = new URL(decodedText);
        const g = u.searchParams.get('guest');
        return g ? g : decodedText;
    } catch (e) {
        // not a URL -> treat as id
        return decodedText;
    }
}

// saat QR berhasil dibaca
function onScanSuccess(decodedText, decodedResult) {
    const guestId = extractGuestId(decodedText).trim();
    if (!guestId) {
        resultDiv.innerHTML = `<p class="error">QR tidak mengandung ID tamu.</p>`;
        playErrorSound();
        return;
    }
    // jalankan check-in via JSONP
    doCheckinJSONP(guestId);
}

// on failure: abaikan (akan terus scan)
function onScanFailure(errorMessage) {
    // silence
}

// inisialisasi html5-qrcode
const html5QrCode = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: { width: 250, height: 250 } };

html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
    .then(() => {
        // started
    })
    .catch((err) => {
        resultDiv.innerHTML = `<p class="error">Tidak dapat mengakses kamera. Pastikan izin diberikan dan kamera tidak dipakai aplikasi lain.</p>`;
        console.error('Unable to start scanning, error:', err);
    });

// JSONP helper: panggil Apps Script dengan callback untuk hindari CORS
function doCheckinJSONP(id) {
    // tampil loading
    resultDiv.innerHTML = `<div style="display:flex;gap:12px;align-items:center;justify-content:center"><div class="spinner" aria-hidden="true"></div><div>Memproses check-in...</div></div>`;

    return new Promise((resolve, reject) => {
        const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        // attach callback
        window[cbName] = function(data) {
            // cleanup
            const s = document.getElementById(cbName + '_script');
            if (s) s.remove();
            try { delete window[cbName]; } catch(e) {}

            // handle response
            if (data && data.success) {
                resultDiv.innerHTML = `<p class="success"><i class="fas fa-check-circle"></i> Selamat datang, ${escapeHtml(data.name)}!</p>`;
                playSuccessSound();
            } else {
                const errMsg = data && data.error ? data.error : 'Gagal check-in';
                resultDiv.innerHTML = `<p class="error"><i class="fas fa-exclamation-triangle"></i> ${escapeHtml(errMsg)}</p>`;
                playErrorSound();
            }
            resolve(data);
        };

        // build script src
        const sourceValue = INVITE_DOMAIN || window.location.hostname;
        const script = document.createElement('script');
        script.id = cbName + '_script';
        // encodeURIComponent for safety; callback param must be function name (no encoding)
        script.src = `${BACKEND_URL}?action=checkin&id=${encodeURIComponent(id)}&callback=${cbName}&key=${encodeURIComponent(CHECKIN_KEY)}&source=${encodeURIComponent(sourceValue)}`;
        script.onerror = function() {
            resultDiv.innerHTML = `<p class="error">Gagal terhubung ke server. Periksa koneksi internet atau deployment Apps Script.</p>`;
            try { delete window[cbName]; } catch(e){}
            script.remove();
            reject(new Error('Script load error'));
        };
        // append to body to execute
        document.body.appendChild(script);
    }).then(() => {
        // hentikan scanning sementara untuk mencegah double-scan
        return html5QrCode.stop().then(() => {
            // restart setelah jeda 2.5s
            setTimeout(() => {
                resultDiv.innerHTML = `<p class="scanning-text">Menunggu QR Code berikutnya...</p>`;
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch((err) => {
                        console.error('Restart scanning failed:', err);
                        resultDiv.innerHTML = `<p class="error">Gagal memulai ulang kamera.</p>`;
                    });
            }, 2500);
        }).catch(err => {
            console.error('Stop scanning failed:', err);
        });
    }).catch(err => {
        console.error(err);
    });
}

// suara
function playSuccessSound() {
    try { new Audio('https://assets.mixkit.co/active_storage/sfx/2568/sfx-confirmation.wav').play(); } catch(e){}
}
function playErrorSound() {
    try { new Audio('https://assets.mixkit.co/active_storage/sfx/2569/sfx-alert.wav').play(); } catch(e){}
}

// small escaping helper for safety
function escapeHtml(s) {
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
</script>
</body>
</html>
